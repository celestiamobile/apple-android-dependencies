name: Build All Platforms

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.0). If provided, will create a GitHub release'
        required: false
        default: ''
        type: string
      prerelease:
        description: 'Mark release as prerelease'
        required: false
        default: false
        type: boolean

env:
  XCODE_VERSION: "16.4"
  NDK_VERSION: "r28c"

jobs:
  # Apple platforms
  ios:
    uses: ./.github/workflows/reusable-build.yml
    with:
      platform: ios
      runner: macos-15
      xcode-version: "16.4"

  ios-simulator:
    uses: ./.github/workflows/reusable-build.yml
    with:
      platform: iossim
      runner: macos-15
      xcode-version: "16.4"

  visionos:
    uses: ./.github/workflows/reusable-build.yml
    with:
      platform: visionos
      runner: macos-15
      xcode-version: "16.4"

  visionos-simulator:
    uses: ./.github/workflows/reusable-build.yml
    with:
      platform: visionossim
      runner: macos-15
      xcode-version: "16.4"

  macos:
    uses: ./.github/workflows/reusable-build.yml
    with:
      platform: mac
      runner: macos-15
      xcode-version: "16.4"

  mac-catalyst:
    uses: ./.github/workflows/reusable-build.yml
    with:
      platform: catalyst
      runner: macos-15
      xcode-version: "16.4"

  # Cross-platform builds
  android:
    uses: ./.github/workflows/reusable-build.yml
    with:
      platform: android
      runner: ubuntu-24.04
      ndk-version: "r28c"

  emscripten:
    uses: ./.github/workflows/reusable-build.yml
    with:
      platform: emscripten
      runner: macos-15
      xcode-version: "16.4"
      setup-emscripten: true

  xcframework:
    name: Generate XCFramework
    runs-on: macos-15
    needs: [ios, ios-simulator, visionos, visionos-simulator, macos, mac-catalyst]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate XCFramework
        uses: ./.github/actions/generate-xcframework
        with:
          xcode-version: "16.4"

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [android, xcframework]
    if: ${{ github.event.inputs.release_tag != '' }}
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release
        uses: ./.github/actions/create-release
        with:
          tag-name: ${{ github.event.inputs.release_tag }}
          release-name: 'Celestia Dependencies'
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
