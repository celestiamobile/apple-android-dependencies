jobs:
- job: Build
  displayName: 'Build'
  timeoutInMinutes: 120
  pool:
    vmImage: macos-12

  variables:
    buildTarget: ${{ parameters.buildTarget }}
    xcodeVersion: ${{ '14.2' }}
    ndkVersion: ${{ '25.2.9519653' }}

  steps:
  - script: brew install meson wget
    displayName: 'Install Dependencies'

  - script: sh ./download.sh
    displayName: 'Download'

  - script: |
      TO_REPLACE="Xcode.app"
      NEW_STRING="Xcode_$(xcodeVersion).app"
      sed -ie "s#${TO_REPLACE}#${NEW_STRING}#g" *.txt
      TO_REPLACE="/Users/linfel/Library/Android/sdk/ndk/25.1.8937393"
      NEW_STRING="$ANDROID_HOME/ndk/$(ndkVersion)"
      sed -ie "s#${TO_REPLACE}#${NEW_STRING}#g" *.txt
      find . -name "*.txt" | xargs cat
    displayName: 'Replace Strings'

  - script: |
      export NDK=$ANDROID_HOME/ndk/$(ndkVersion)
      sudo xcode-select -s /Applications/Xcode_$(xcodeVersion).app
      sh ./prepare_icu.sh
      sh ./build_$(buildTarget).sh
    displayName: 'Build'

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(buildTarget)'
      ArtifactName: '$(buildTarget)'
      publishLocation: 'Container'
    displayName: 'Publish'
